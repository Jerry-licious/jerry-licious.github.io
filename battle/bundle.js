(()=>{"use strict";const e=document.getElementById("attackerAttack"),t=document.getElementById("attackerDefence"),n=document.getElementById("attackerInitiative"),i=document.getElementById("attackerHP"),a=document.getElementById("attackerDoctrine"),r=document.getElementById("attackerDoctrineLevel"),c=document.getElementById("attackerErrors"),s=document.getElementById("defenderAttack"),d=document.getElementById("defenderDefence"),o=document.getElementById("defenderInitiative"),l=document.getElementById("defenderHP"),u=document.getElementById("defenderDoctrine"),h=document.getElementById("defenderDoctrineLevel"),m=document.getElementById("defenderErrors"),f=document.getElementById("fightButton"),v=document.getElementById("swapButton"),p=document.getElementById("againButton"),k=document.getElementById("result"),g=document.getElementById("resultAttackerAttack"),w=document.getElementById("resultAttackerDefence"),I=document.getElementById("resultAttackerInitiative"),M=document.getElementById("resultAttackerHP"),y=document.getElementById("resultDefenderAttack"),E=document.getElementById("resultDefenderDefence"),b=document.getElementById("resultDefenderInitiative"),L=document.getElementById("resultDefenderHP");function A(e,t){return Math.max(.5,e*(1-Math.log(t+1)/Math.log(e+3)))}class B{constructor(e,t,n){this.attackerWon=e,this.attacker=t,this.defender=n}}class D{constructor(e,t=1){this.add=e,this.multiply=t}apply(e){return(e+this.add)*this.multiply}}const H=new D(0,1);function T(e){return new D(e)}class P{constructor({attack:e=H,defence:t=H,attackInitiativeCost:n=H,winRate:i=H,damageTakenOnFailedAttack:a=H,shock:r=0,enemyAttackInitiativeCost:c=H,maxHP:s=H,healOnVictory:d=0,initiativeGainOnVictory:o=0}){this.attack=e,this.defence=t,this.attackInitiativeCost=n,this.shock=r,this.enemyAttackInitiativeCost=c,this.winRate=i,this.damageTakenOnFailedAttack=a,this.maxHP=s,this.healOnVictory=d,this.initiativeGainOnVictory=o}}P.none=new P({});class S{constructor(e,t,n){this.id=e,this.name=t,this.bonuses=n}effectsLevel(e){return this.bonuses[Math.min(e-1,this.bonuses.length-1)]}static getBonuses(e,t){return this.doctrinesMap.has(e)?this.doctrinesMap.get(e).effectsLevel(t):P.none}}S.none=new S("none","None",[P.none]),S.doctrinesList=[S.none,new S("naval","Naval Dominance",[new P({attack:T(2),defence:T(2)}),new P({attack:T(4),defence:T(3)})]),new S("tanks","Mobile Warfare",[new P({attack:T(1),defence:T(2)}),new P({attack:T(2),defence:T(4)})]),new S("mass","Mass Assault",[new P({maxHP:T(1)}),new P({maxHP:T(2)}),new P({maxHP:T(2),healOnVictory:3})]),new S("firepower","Superior Firepower",[new P({attack:T(2)}),new P({attack:T(4)}),new P({attack:T(4),shock:3})]),new S("relentless","Relentless Attack",[new P({attackInitiativeCost:T(-1)}),new P({attackInitiativeCost:T(-1),initiativeGainOnVictory:8})]),new S("opportunist","Decisive Strike",[new P({winRate:T(.7)}),new P({winRate:T(.15)}),new P({winRate:T(.15),damageTakenOnFailedAttack:(0,new D(0,0))})]),new S("fort","Mobile Fortress",[new P({defence:T(2)}),new P({defence:T(4)}),new P({defence:T(4),enemyAttackInitiativeCost:T(2)})]),new S("home","Guerrilla Warfare",[new P({defence:T(3)})])],S.doctrinesMap=new Map(S.doctrinesList.map((e=>[e.id,e]))),S.doctrineNames=new Map(S.doctrinesList.map((e=>[e.id,e.name])));class O{constructor(e,t,n,i,a=S.none,r=1){this.baseAttack=e,this.baseDefence=t,this.initiative=n,this.hp=i,this.doctrine=a,this.doctrineLevel=r}get doctrineModifier(){return this.doctrine.effectsLevel(this.doctrineLevel)}get attack(){return this.doctrineModifier.attack.apply(this.baseAttack)}get defence(){return this.doctrineModifier.defence.apply(this.baseDefence)}get power(){return(-this.baseAttack*this.baseDefence+Math.pow(this.baseAttack+this.baseDefence,2))*this.initiative*this.hp}get canFight(){return this.initiative>=0&&this.hp>0}clone(){return new O(this.baseAttack,this.baseDefence,this.initiative,this.hp,this.doctrine,this.doctrineLevel)}damage(e){let t=this.clone();return t.hp-=e,t}decreaseInitiative(e){let t=this.clone();return t.initiative-=e,t}get maxHP(){return this.doctrineModifier.maxHP.apply(10)}attackUnit(e){let t=this.clone(),n=t.power,i=n/(n+e.power),a=t.doctrineModifier.winRate.apply(function(e){return t=7*(e-.5),1/(1+Math.exp(-t));var t}(i)),r=Math.random()<a;return t=t.decreaseInitiative(e.doctrineModifier.enemyAttackInitiativeCost.apply(t.doctrineModifier.attackInitiativeCost.apply(2))),r?(t=t.damage(Math.floor(A(.3*e.baseAttack,t.baseDefence))),(e=e.damage(Math.ceil(A(t.baseAttack,e.baseDefence))).decreaseInitiative(t.doctrineModifier.shock)).canFight||(t.hp=Math.min(t.hp+t.doctrineModifier.healOnVictory,t.maxHP),t.initiative=Math.min(t.initiative+t.doctrineModifier.initiativeGainOnVictory,30))):(e=e.damage(Math.floor(A(.3*t.baseAttack*.4,t.baseDefence))),t=t.damage(t.doctrineModifier.damageTakenOnFailedAttack.apply(Math.ceil(A(.4*e.baseAttack,t.baseDefence))))),t.initiative<0&&(t.initiative=0),e.initiative<0&&(e.initiative=0),new B(r,t,e)}}let x=null;function F(e,t,n,i,a,r){return new O(parseInt(e.value),parseInt(t.value),parseInt(n.value),parseInt(i.value),S.doctrinesMap.get(a.value),parseInt(r.value))}function C(){return F(e,t,n,i,a,r)}function V(){return F(s,d,o,l,u,h)}function R(e,t,n,i,a,r,c){t.value=e.baseAttack.toString(),n.value=e.baseDefence.toString(),i.value=e.initiative.toString(),a.value=e.hp.toString(),r.value=e.doctrine.id,c.value=e.doctrineLevel.toString()}function G(e){return(Math.round(100*e)/100).toString()}function N(e){S.doctrineNames.forEach(((t,n)=>{let i=document.createElement("option");i.value=n,i.innerHTML=t,e.append(i)}))}let W=[],U=[];function j(e,t,n,i,a){let r=[];if(e||r.push("Missing attack value."),t||r.push("Missing defence value."),n){let e=parseInt(n);(e<0||e>30)&&r.push("Initiative must be between 0 and 30.")}else r.push("Missing initiative value.");if(i){let e=parseInt(i);(e<0||e>12)&&r.push("HP must be between 0 and 12.")}else r.push("Missing HP value.");if(a){let e=parseInt(a);(e<0||e>3)&&r.push("Doctrine level must be between 1 and 3")}else r.push("Missing doctrine level");return r}function q(e,t){e.innerHTML="";for(let n of t)e.append(document.createTextNode(n)),e.append(document.createElement("br"))}function z(e){e.classList.remove("disabled"),e.parentElement.classList.remove("disabled")}function J(e){e.classList.add("disabled"),e.parentElement.classList.add("disabled")}function K(){0!==W.length||0!==U.length?(J(f),J(v)):(z(f),z(v)),x&&x.attacker.canFight&&x.defender.canFight?z(p):J(p)}function Q(){W=j(e.value,t.value,n.value,i.value,r.value),q(c,W),K()}function X(){U=j(s.value,d.value,o.value,l.value,h.value),q(m,U),K()}e.addEventListener("input",Q),t.addEventListener("input",Q),n.addEventListener("input",Q),i.addEventListener("input",Q),r.addEventListener("input",Q),s.addEventListener("input",X),d.addEventListener("input",X),o.addEventListener("input",X),l.addEventListener("input",X),h.addEventListener("input",Q),Q(),X(),N(a),N(u),f.addEventListener("click",(function(){let e=C(),t=V();x=e.attackUnit(t),k.innerHTML=x.attackerWon?"Attacker won!":"Defender won!",g.innerHTML=x.attacker.baseAttack.toString(),w.innerHTML=x.attacker.baseDefence.toString(),I.innerHTML=G(x.attacker.initiative),M.innerHTML=x.attacker.hp.toString(),y.innerHTML=x.defender.baseAttack.toString(),E.innerHTML=x.defender.baseDefence.toString(),b.innerHTML=G(x.defender.initiative),L.innerHTML=x.defender.hp.toString(),p.disabled=!1,K()})),v.addEventListener("click",(function(){let c=C();R(V(),e,t,n,i,a,r),R(c,s,d,o,l,u,h)})),p.addEventListener("click",(function(){R(x.attacker,e,t,n,i,a,r),R(x.defender,s,d,o,l,u,h),Q(),X()}))})();